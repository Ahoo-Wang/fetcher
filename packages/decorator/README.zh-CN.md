# @ahoo-wang/fetcher-decorator

[![npm version](https://img.shields.io/npm/v/@ahoo-wang/fetcher-decorator.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![Build Status](https://github.com/Ahoo-Wang/fetcher/actions/workflows/ci.yml/badge.svg)](https://github.com/Ahoo-Wang/fetcher/actions)
[![codecov](https://codecov.io/gh/Ahoo-Wang/fetcher/graph/badge.svg?token=JGiWZ52CvJ)](https://codecov.io/gh/Ahoo-Wang/fetcher)
[![License](https://img.shields.io/npm/l/@ahoo-wang/fetcher-decorator.svg)](https://github.com/Ahoo-Wang/fetcher/blob/main/LICENSE)
[![npm downloads](https://img.shields.io/npm/dm/@ahoo-wang/fetcher-decorator.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![npm bundle size](https://img.shields.io/bundlephobia/minzip/%40ahoo-wang%2Ffetcher-decorator)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/Ahoo-Wang/fetcher)

Fetcher HTTP å®¢æˆ·ç«¯çš„è£…é¥°å™¨æ”¯æŒã€‚ä½¿ç”¨ TypeScript è£…é¥°å™¨å®ç°ç®€æ´ã€å£°æ˜å¼çš„ API æœåŠ¡å®šä¹‰ã€‚

## ğŸŒŸ åŠŸèƒ½ç‰¹æ€§

- **ğŸ¨ ç®€æ´çš„ API å®šä¹‰**ï¼šä½¿ç”¨ç›´è§‚çš„è£…é¥°å™¨å®šä¹‰ HTTP æœåŠ¡
- **ğŸ§­ è‡ªåŠ¨å‚æ•°ç»‘å®š**ï¼šè·¯å¾„ã€æŸ¥è¯¢ã€å¤´éƒ¨å’Œè¯·æ±‚ä½“å‚æ•°è‡ªåŠ¨ç»‘å®š
- **â±ï¸ å¯é…ç½®è¶…æ—¶**ï¼šæ”¯æŒæ¯æ–¹æ³•å’Œæ¯ç±»çš„è¶…æ—¶è®¾ç½®
- **ğŸ”— Fetcher é›†æˆ**ï¼šä¸ Fetcher çš„å‘½å fetcher ç³»ç»Ÿæ— ç¼é›†æˆ
- **ğŸ›¡ï¸ TypeScript æ”¯æŒ**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **âš¡ è‡ªåŠ¨å®ç°**ï¼šæ–¹æ³•è‡ªåŠ¨å®ç°ä¸º HTTP è°ƒç”¨
- **ğŸ“¦ å…ƒæ•°æ®ç³»ç»Ÿ**ï¼šä¸°å¯Œçš„å…ƒæ•°æ®æ”¯æŒï¼Œç”¨äºé«˜çº§å®šåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# ä½¿ç”¨ npm
npm install @ahoo-wang/fetcher-decorator

# ä½¿ç”¨ pnpm
pnpm add @ahoo-wang/fetcher-decorator

# ä½¿ç”¨ yarn
yarn add @ahoo-wang/fetcher-decorator
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹ï¼šTypicode Post æœåŠ¡

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä¸º JSONPlaceholder API å®šä¹‰æœåŠ¡ï¼Œç±»ä¼¼äº Fetcher
é¡¹ç›®ä¸­çš„é›†æˆæµ‹è¯•ã€‚æ‚¨å¯ä»¥åœ¨ [integration-test/src/decorator/typicodePostService.ts](../../integration-test/src/decorator/typicodePostService.ts)
ä¸­æ‰¾åˆ°å®Œæ•´å®ç°ã€‚

```typescript
import {
  api,
  autoGeneratedError,
  body,
  del,
  get,
  post,
  patch,
  path,
  put,
  query,
} from '@ahoo-wang/fetcher-decorator';
import { typicodeFetcher } from '../fetcher';
import { Post } from '../types';

@api('/posts', { fetcher: typicodeFetcher })
export class TypicodePostService {
  @get('')
  getPosts(): Promise<Post[]> {
    throw autoGeneratedError();
  }

  @get('/{postId}')
  getPost(@path('postId') postId: string): Promise<Post> {
    throw autoGeneratedError();
  }

  @post('')
  createPost(@body() post: Post): Promise<Post> {
    throw autoGeneratedError();
  }

  @put('/{postId}')
  updatePost(
    @path('postId') postId: string,
    @body() post: Post,
  ): Promise<Post> {
    throw autoGeneratedError();
  }

  @patch('/{postId}')
  patchPost(
    @path('postId') postId: string,
    @body() post: Partial<Post>,
  ): Promise<Post> {
    throw autoGeneratedError();
  }

  @del('/{postId}')
  deletePost(@path('postId') postId: string): Promise<object> {
    throw autoGeneratedError();
  }

  @get('')
  filterPosts(
    @query('userId') userId?: string,
    @query('completed') completed?: boolean,
  ): Promise<Post[]> {
    throw autoGeneratedError();
  }
}

export const typicodePostService = new TypicodePostService();
```

### åŸºæœ¬ç”¨æ³•

```typescript
import { NamedFetcher, fetcherRegistrar } from '@ahoo-wang/fetcher';
import {
  api,
  get,
  post,
  path,
  query,
  body,
} from '@ahoo-wang/fetcher-decorator';

// åˆ›å»ºå¹¶æ³¨å†Œ fetcher
const userFetcher = new NamedFetcher('user', {
  baseURL: 'https://api.user-service.com',
});

// ä½¿ç”¨è£…é¥°å™¨å®šä¹‰æœåŠ¡ç±»
@api('/users', { fetcher: 'user', timeout: 10000 })
class UserService {
  @post('/', { timeout: 5000 })
  createUser(@body() user: User): Promise<User> {
    throw autoGeneratedError(user);
  }

  @get('/{id}')
  getUser(@path() id: number, @query() include: string): Promise<User> {
    throw autoGeneratedError(id, include);
  }
}

// ä½¿ç”¨æœåŠ¡
const userService = new UserService();
const response = await userService.createUser({ name: 'John' });
```

## ğŸ“š API å‚è€ƒ

### ç±»è£…é¥°å™¨

#### `@api(basePath, metadata)`

ä¸ºç±»å®šä¹‰ API å…ƒæ•°æ®ã€‚

**å‚æ•°ï¼š**

- `basePath`: ç±»ä¸­æ‰€æœ‰ç«¯ç‚¹çš„åŸºç¡€è·¯å¾„
- `metadata`: API çš„é¢å¤–å…ƒæ•°æ®
  - `headers`: ç±»ä¸­æ‰€æœ‰è¯·æ±‚çš„é»˜è®¤å¤´éƒ¨
  - `timeout`: ç±»ä¸­æ‰€æœ‰è¯·æ±‚çš„é»˜è®¤è¶…æ—¶æ—¶é—´
  - `fetcher`: è¦ä½¿ç”¨çš„ fetcher å®ä¾‹åç§°ï¼ˆé»˜è®¤ï¼š'default'ï¼‰

**ç¤ºä¾‹ï¼š**

```typescript
@api('/api/v1', {
  headers: { 'X-API-Version': '1.0' },
  timeout: 5000,
  fetcher: 'api',
})
class ApiService {
  // ...
}
```

### æ–¹æ³•è£…é¥°å™¨

#### `@get(path, metadata)`

å®šä¹‰ GET ç«¯ç‚¹ã€‚

#### `@post(path, metadata)`

å®šä¹‰ POST ç«¯ç‚¹ã€‚

#### `@put(path, metadata)`

å®šä¹‰ PUT ç«¯ç‚¹ã€‚

#### `@del(path, metadata)`

å®šä¹‰ DELETE ç«¯ç‚¹ã€‚

#### `@patch(path, metadata)`

å®šä¹‰ PATCH ç«¯ç‚¹ã€‚

#### `@head(path, metadata)`

å®šä¹‰ HEAD ç«¯ç‚¹ã€‚

#### `@options(path, metadata)`

å®šä¹‰ OPTIONS ç«¯ç‚¹ã€‚

**é€šç”¨å‚æ•°ï¼š**

- `path`: ç«¯ç‚¹è·¯å¾„ï¼ˆç›¸å¯¹äºç±»åŸºç¡€è·¯å¾„ï¼‰
- `metadata`: ç«¯ç‚¹çš„é¢å¤–å…ƒæ•°æ®
  - `headers`: è¯·æ±‚çš„å¤´éƒ¨
  - `timeout`: è¯·æ±‚çš„è¶…æ—¶æ—¶é—´
  - `fetcher`: è¦ä½¿ç”¨çš„ fetcher å®ä¾‹åç§°

**ç¤ºä¾‹ï¼š**

```typescript
class UserService {
  @get('/{id}', { timeout: 3000 })
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }

  @post('/', { headers: { 'Content-Type': 'application/json' } })
  createUser(@body() user: User): Promise<Response> {
    throw autoGeneratedError(user);
  }
}
```

### å‚æ•°è£…é¥°å™¨

#### `@path(name)`

å®šä¹‰è·¯å¾„å‚æ•°ã€‚åç§°æ˜¯å¯é€‰çš„ - å¦‚æœæœªæä¾›ï¼Œå°†ä½¿ç”¨åå°„ä»æ–¹æ³•å‚æ•°åè‡ªåŠ¨æå–ã€‚

**å‚æ•°ï¼š**

- `name`: å‚æ•°åç§°ï¼ˆåœ¨è·¯å¾„æ¨¡æ¿ä¸­ä½¿ç”¨ï¼Œå¯é€‰ - å¦‚æœæœªæä¾›åˆ™è‡ªåŠ¨æå–ï¼‰

#### `@query(name)`

å®šä¹‰æŸ¥è¯¢å‚æ•°ã€‚åç§°æ˜¯å¯é€‰çš„ - å¦‚æœæœªæä¾›ï¼Œå°†ä½¿ç”¨åå°„ä»æ–¹æ³•å‚æ•°åè‡ªåŠ¨æå–ã€‚

**å‚æ•°ï¼š**

- `name`: å‚æ•°åç§°ï¼ˆåœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ä½¿ç”¨ï¼Œå¯é€‰ - å¦‚æœæœªæä¾›åˆ™è‡ªåŠ¨æå–ï¼‰

#### `@body()`

å®šä¹‰è¯·æ±‚ä½“ã€‚è¯·æ±‚ä½“å‚æ•°æ²¡æœ‰åç§°ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚åªæœ‰ä¸€ä¸ªè¯·æ±‚ä½“ã€‚

#### `@header(name)`

å®šä¹‰å¤´éƒ¨å‚æ•°ã€‚åç§°æ˜¯å¯é€‰çš„ - å¦‚æœæœªæä¾›ï¼Œå°†ä½¿ç”¨åå°„ä»æ–¹æ³•å‚æ•°åè‡ªåŠ¨æå–ã€‚

**å‚æ•°ï¼š**

- `name`: å¤´éƒ¨åç§°ï¼ˆå¯é€‰ - å¦‚æœæœªæä¾›åˆ™è‡ªåŠ¨æå–ï¼‰

#### `@request()`

å®šä¹‰è¯·æ±‚å‚æ•°ï¼Œå°†ç”¨ä½œåŸºç¡€è¯·æ±‚å¯¹è±¡ã€‚è¿™å…è®¸æ‚¨ä¼ é€’ä¸€ä¸ªå®Œæ•´çš„ FetcherRequest å¯¹è±¡æ¥è‡ªå®šä¹‰è¯·æ±‚é…ç½®ã€‚

**ç¤ºä¾‹ï¼š**

```typescript
class UserService {
  @get('/search')
  searchUsers(
    @query('q') query: string,
    @query() limit: number,
    @header('Authorization') auth: string,
  ): Promise<Response> {
    throw autoGeneratedError(query, limit, auth);
  }

  @post('/users')
  createUsers(@request() request: FetcherRequest): Promise<Response> {
    throw autoGeneratedError(request);
  }

  @put('/{id}')
  updateUser(@path() id: number, @body() user: User): Promise<Response> {
    throw autoGeneratedError(id, user);
  }
}
```

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### ç»§æ‰¿æ”¯æŒ

```typescript
@api('/base')
class BaseService {
  @get('/status')
  getStatus(): Promise<Response> {
    throw autoGeneratedError();
  }
}

@api('/users')
class UserService extends BaseService {
  @get('/{id}')
  getUser(@path() id: number): Promise<Response> {
    throw autoGeneratedError(id);
  }
}
```

### å¤æ‚å‚æ•°å¤„ç†

```typescript
@api('/api')
class ComplexService {
  @post('/batch')
  batchOperation(
    @body() items: Item[],
    @header('X-Request-ID') requestId: string,
    @query() dryRun: boolean = false,
  ): Promise<Response> {
    throw autoGeneratedError(items, requestId, dryRun);
  }
}
```

### è¯·æ±‚åˆå¹¶

å½“ä½¿ç”¨ `@request()` è£…é¥°å™¨æ—¶ï¼Œæä¾›çš„ `FetcherRequest` å¯¹è±¡ä¼šä½¿ç”¨å¤æ‚çš„åˆå¹¶ç­–ç•¥ä¸ç«¯ç‚¹ç‰¹å®šé…ç½®è¿›è¡Œåˆå¹¶ï¼š

- **åµŒå¥—å¯¹è±¡**ï¼ˆè·¯å¾„ã€æŸ¥è¯¢ã€å¤´éƒ¨ï¼‰ä¼šè¢«é€’å½’åˆå¹¶ï¼Œå‚æ•°å€¼ä¼˜å…ˆ
- **åŸºæœ¬å€¼**ï¼ˆæ–¹æ³•ã€è¯·æ±‚ä½“ã€è¶…æ—¶ã€ä¿¡å·ï¼‰æ¥è‡ªå‚æ•°è¯·æ±‚çš„å€¼ä¼šè¦†ç›–ç«¯ç‚¹å€¼
- **ç©ºå¯¹è±¡**ä¼šè¢«ä¼˜é›…åœ°å¤„ç†ï¼Œå›é€€åˆ°ç«¯ç‚¹é…ç½®

```typescript
@api('/users')
class UserService {
  @post('/')
  createUsers(
    @body() user: User,
    @request() request: FetcherRequest,
  ): Promise<Response> {
    // æœ€ç»ˆè¯·æ±‚å°†åˆå¹¶ï¼š
    // - ç«¯ç‚¹æ–¹æ³•ï¼ˆPOSTï¼‰
    // - è¯·æ±‚ä½“å‚æ•°ï¼ˆuser å¯¹è±¡ï¼‰
    // - æ¥è‡ª request å‚æ•°çš„ä»»ä½•é…ç½®
    throw autoGeneratedError(user, request);
  }
}
```

### Fetcher è§£æä¼˜å…ˆçº§

ç”¨äºå‘èµ· HTTP è¯·æ±‚çš„ fetcher é€šè¿‡ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºç¡®å®šï¼š

1. **æœåŠ¡å®ä¾‹ Fetcher å±æ€§**ï¼šæœåŠ¡å®ä¾‹ä¸Šçš„ `fetcher` å±æ€§å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§
2. **ç«¯ç‚¹çº§åˆ« Fetcher**ï¼šåœ¨ç«¯ç‚¹å…ƒæ•°æ®ä¸­æŒ‡å®šçš„ fetcherï¼ˆ`@get('/path', { fetcher: 'name' })`ï¼‰
3. **ç±»çº§åˆ« Fetcher**ï¼šåœ¨ç±»å…ƒæ•°æ®ä¸­æŒ‡å®šçš„ fetcherï¼ˆ`@api('/base', { fetcher: 'name' })`ï¼‰
4. **é»˜è®¤ Fetcher**ï¼šå¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰æŒ‡å®šï¼Œåˆ™å›é€€åˆ°é»˜è®¤ fetcher

```typescript
// å±•ç¤º fetcher è§£æä¼˜å…ˆçº§çš„ç¤ºä¾‹
const customFetcher = new Fetcher({ baseURL: 'https://custom-api.com' });

@api('/users', { fetcher: 'class-level-fetcher' })
class UserService {
  @get('/{id}', { fetcher: 'endpoint-level-fetcher' })
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }
}

// å¸¦æœ‰ fetcher å±æ€§çš„æœåŠ¡å®ä¾‹ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
const userService = new UserService();
userService.fetcher = customFetcher; // å°†ä½¿ç”¨æ­¤ fetcher

// å¦‚æœå®ä¾‹ä¸Šæ²¡æœ‰è®¾ç½® fetcher å±æ€§ï¼Œåˆ™ä¼šä½¿ç”¨ï¼š
// 1. 'endpoint-level-fetcher'ï¼ˆæ¥è‡ª @get è£…é¥°å™¨ï¼‰
// 2. 'class-level-fetcher'ï¼ˆæ¥è‡ª @api è£…é¥°å™¨ï¼‰
// 3. é»˜è®¤ fetcherï¼ˆå¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰æŒ‡å®šï¼‰
```

### ç»“æœæå–å™¨

ç»“æœæå–å™¨ç”¨äºå¤„ç†å’Œæå–åº”ç”¨ç¨‹åºä¸­ä¸åŒç±»å‹å“åº”æˆ–ç»“æœçš„æ•°æ®ã€‚
å®ƒä»¬å…è®¸æ‚¨è‡ªå®šä¹‰å¦‚ä½•å¤„ç†å’Œè¿”å› HTTP è¯·æ±‚çš„å“åº”ã€‚

#### å¯ç”¨çš„ç»“æœæå–å™¨

- **ExchangeResultExtractor**: è¿”å›åŸå§‹çš„ FetchExchange å¯¹è±¡
- **ResponseResultExtractor**: è¿”å› FetchExchange ä¸­çš„å“åº”å¯¹è±¡
- **JsonResultExtractor**: å°†å“åº”å†…å®¹è§£æä¸º JSON æ ¼å¼ï¼ˆé»˜è®¤ï¼‰
- **TextResultExtractor**: å°†å“åº”å†…å®¹è§£æä¸ºæ–‡æœ¬æ ¼å¼
- **EventStreamResultExtractor**: ä» FetchExchange ä¸­æå–æœåŠ¡å™¨å‘é€äº‹ä»¶æµ
- **JsonEventStreamResultExtractor**: ä» FetchExchange ä¸­æå– JSON æœåŠ¡å™¨å‘é€äº‹ä»¶æµ

#### ä½¿ç”¨ç»“æœæå–å™¨

æ‚¨å¯ä»¥åœ¨ç±»çº§åˆ«æˆ–æ–¹æ³•çº§åˆ«æŒ‡å®šç»“æœæå–å™¨ï¼š

```typescript
import { ResultExtractors } from '@ahoo-wang/fetcher-decorator';

@api('/users', { resultExtractor: ResultExtractors.Json })
class UserService {
  // ä½¿ç”¨ç±»çº§åˆ«çš„ JSON ç»“æœæå–å™¨
  @get('/{id}')
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }

  // ä½¿ç”¨ EventStream ç»“æœæå–å™¨è¦†ç›–
  @get('/events', { resultExtractor: ResultExtractors.EventStream })
  getUserEvents(): Promise<ServerSentEventStream> {
    throw autoGeneratedError();
  }

  // ä½¿ç”¨ JsonEventStream ç»“æœæå–å™¨å¤„ç† JSON äº‹ä»¶
  @get('/json-events', {
    resultExtractor: ResultExtractors.JsonEventStream,
  })
  getJsonEvents(): Promise<JsonServerSentEventStream<MyDataType>> {
    throw autoGeneratedError();
  }
}
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œå¸¦è¦†ç›–ç‡çš„æµ‹è¯•
pnpm test --coverage
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](https://github.com/Ahoo-Wang/fetcher/blob/main/CONTRIBUTING.md) äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

## ğŸ“„ è®¸å¯è¯

Apache-2.0

---

<p align="center">
  Fetcher ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†
</p>
