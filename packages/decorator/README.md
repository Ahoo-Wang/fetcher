# @ahoo-wang/fetcher-decorator

[![npm version](https://img.shields.io/npm/v/@ahoo-wang/fetcher-decorator.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![Build Status](https://github.com/Ahoo-Wang/fetcher/actions/workflows/ci.yml/badge.svg)](https://github.com/Ahoo-Wang/fetcher/actions)
[![codecov](https://codecov.io/gh/Ahoo-Wang/fetcher/graph/badge.svg?token=JGiWZ52CvJ)](https://codecov.io/gh/Ahoo-Wang/fetcher)
[![License](https://img.shields.io/npm/l/@ahoo-wang/fetcher-decorator.svg)](https://github.com/Ahoo-Wang/fetcher/blob/main/LICENSE)
[![npm downloads](https://img.shields.io/npm/dm/@ahoo-wang/fetcher-decorator.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![npm bundle size](https://img.shields.io/bundlephobia/minzip/%40ahoo-wang%2Ffetcher-decorator)](https://www.npmjs.com/package/@ahoo-wang/fetcher-decorator)
[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/Ahoo-Wang/fetcher)

Transform your API interactions with clean, declarative service definitions using TypeScript decorators.

## üåü Features

- **üé® Clean API Definitions**: Define HTTP services using intuitive decorators
- **üß≠ Automatic Parameter Binding**: Path, query, header, and body parameters automatically bound
- **‚è±Ô∏è Configurable Timeouts**: Per-method and per-class timeout settings
- **üîó Fetcher Integration**: Seamless integration with Fetcher's named fetcher system
- **üõ°Ô∏è TypeScript Support**: Complete TypeScript type definitions
- **‚ö° Automatic Implementation**: Methods automatically implemented with HTTP calls
- **üì¶ Metadata System**: Rich metadata support for advanced customization

## üöÄ Quick Start

### Installation

```bash
# Using npm
npm install @ahoo-wang/fetcher-decorator

# Using pnpm
pnpm add @ahoo-wang/fetcher-decorator

# Using yarn
yarn add @ahoo-wang/fetcher-decorator
```

### Integration Test Example: Typicode Post Service

The following example shows how to define a service for the JSONPlaceholder API, similar to the integration test in the
Fetcher project. You can find the complete implementation
in [integration-test/src/decorator/typicodePostService.ts](../../integration-test/src/decorator/typicodePostService.ts).

```typescript
import {
  api,
  autoGeneratedError,
  body,
  del,
  get,
  post,
  patch,
  path,
  put,
  query,
} from '@ahoo-wang/fetcher-decorator';
import { typicodeFetcher } from '../fetcher';
import { Post } from '../types';

@api('/posts', { fetcher: typicodeFetcher })
export class TypicodePostService {
  @get('')
  getPosts(): Promise<Post[]> {
    throw autoGeneratedError();
  }

  @get('/{postId}')
  getPost(@path('postId') postId: string): Promise<Post> {
    throw autoGeneratedError(postId);
  }

  @post('')
  createPost(@body() post: Post): Promise<Post> {
    throw autoGeneratedError();
  }

  @put('/{postId}')
  updatePost(
    @path('postId') postId: string,
    @body() post: Post,
  ): Promise<Post> {
    throw autoGeneratedError(postId,post);
  }

  @patch('/{postId}')
  patchPost(
    @path('postId') postId: string,
    @body() post: Partial<Post>,
  ): Promise<Post> {
    throw autoGeneratedError(postId,post);
  }

  @del('/{postId}')
  deletePost(@path('postId') postId: string): Promise<object> {
    throw autoGeneratedError(postId);
  }

  @get('')
  filterPosts(
    @query('userId') userId?: string,
    @query('completed') completed?: boolean,
  ): Promise<Post[]> {
    throw autoGeneratedError(userId,completed);
  }
}

export const typicodePostService = new TypicodePostService();
```

### Basic Usage

```typescript
import { NamedFetcher, fetcherRegistrar } from '@ahoo-wang/fetcher';
import {
  api,
  get,
  post,
  path,
  query,
  body,
} from '@ahoo-wang/fetcher-decorator';

// Create and register a fetcher
const userFetcher = new NamedFetcher('user', {
  baseURL: 'https://api.user-service.com',
});

// Define your service class with decorators
@api('/users', { fetcher: 'user', timeout: 10000 })
class UserService {
  @post('/', { timeout: 5000 })
  createUser(@body() user: User): Promise<User> {
    throw autoGeneratedError(user);
  }

  @get('/{id}')
  getUser(@path() id: number, @query() include: string): Promise<User> {
    throw autoGeneratedError(id,include);
  }
}

// Use the service
const userService = new UserService();
const response = await userService.createUser({ name: 'John' });
```

## üìö API Reference

### Class Decorators

#### `@api(basePath, metadata)`

Defines API metadata for a class.

**Parameters:**

- `basePath`: Base path for all endpoints in the class
- `metadata`: Additional metadata for the API
    - `headers`: Default headers for all requests in the class
    - `timeout`: Default timeout for all requests in the class
    - `fetcher`: Name of the fetcher instance to use (default: 'default')

**Example:**

```typescript
@api('/api/v1', {
  headers: { 'X-API-Version': '1.0' },
  timeout: 5000,
  fetcher: 'api',
})
class ApiService {
  // ...
}
```

### Method Decorators

#### `@get(path, metadata)`

Defines a GET endpoint.

#### `@post(path, metadata)`

Defines a POST endpoint.

#### `@put(path, metadata)`

Defines a PUT endpoint.

#### `@del(path, metadata)`

Defines a DELETE endpoint.

#### `@patch(path, metadata)`

Defines a PATCH endpoint.

#### `@head(path, metadata)`

Defines a HEAD endpoint.

#### `@options(path, metadata)`

Defines an OPTIONS endpoint.

**Common parameters:**

- `path`: Path for the endpoint (relative to class base path)
- `metadata`: Additional metadata for the endpoint
    - `headers`: Headers for the request
    - `timeout`: Timeout for the request
    - `fetcher`: Name of the fetcher instance to use

**Example:**

```typescript
class UserService {
  @get('/{id}', { timeout: 3000 })
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }

  @post('/', { headers: { 'Content-Type': 'application/json' } })
  createUser(@body() user: User): Promise<Response> {
    throw autoGeneratedError(user);
  }
}
```

### Parameter Decorators

#### `@path(name)`

Defines a path parameter. The name is optional - if not provided, it will be automatically extracted from the method
parameter name.

**Parameters:**

- `name`: Name of the parameter (used in the path template, optional - auto-extracted if not provided)

#### `@query(name)`

Defines a query parameter. The name is optional - if not provided, it will be automatically extracted from the method
parameter name.

**Parameters:**

- `name`: Name of the parameter (used in the query string, optional - auto-extracted if not provided)

#### `@body()`

Defines a request body. Body parameters don't have names since there's only one body per request.

#### `@header(name)`

Defines a header parameter. The name is optional - if not provided, it will be automatically extracted from the method
parameter name.

**Parameters:**

- `name`: Name of the header (optional - auto-extracted if not provided)

#### `@request()`

Defines a request parameter that will be used as the base request object. This allows you to pass a complete
FetcherRequest
object to customize the request configuration.

**Example:**

```typescript
class UserService {
  @get('/search')
  searchUsers(
    @query('q') query: string,
    @query() limit: number,
    @header('Authorization') auth: string,
  ): Promise<Response> {
    throw autoGeneratedError(query,limit,auth);
  }

  @post('/users')
  createUsers(@request() request: FetcherRequest): Promise<Response> {
    throw autoGeneratedError(request);
  }

  @put('/{id}')
  updateUser(@path() id: number, @body() user: User): Promise<Response> {
    throw autoGeneratedError(id,user);
  }
}
```

## üõ†Ô∏è Advanced Usage

### Inheritance Support

```typescript
@api('/base')
class BaseService {
  @get('/status')
  getStatus(): Promise<Response> {
    throw autoGeneratedError();
  }
}

@api('/users')
class UserService extends BaseService {
  @get('/{id}')
  getUser(@path() id: number): Promise<Response> {
    throw autoGeneratedError(id);
  }
}
```

### Complex Parameter Handling

```typescript
@api('/api')
class ComplexService {
  @post('/batch')
  batchOperation(
    @body() items: Item[],
    @header('X-Request-ID') requestId: string,
    @query() dryRun: boolean = false,
  ): Promise<Response> {
    throw autoGeneratedError(items,requestId,dryRun);
  }
}
```

### Request Merging

When using the `@request()` decorator, the provided `FetcherRequest` object is merged with endpoint-specific
configuration using a sophisticated merging strategy:

- **Nested objects** (path, query, headers) are recursively merged, with parameter values taking precedence
- **Primitive values** (method, body, timeout, signal) from the parameter request override endpoint values
- **Empty objects** are handled gracefully, falling back to endpoint configuration

```typescript
@api('/users')
class UserService {
  @post('/')
  createUsers(
    @body() user: User,
    @request() request: FetcherRequest,
  ): Promise<Response> {
    // The final request will merge:
    // - Endpoint method (POST)
    // - Body parameter (user object)
    // - Any configuration from the request parameter
    throw autoGeneratedError(user,request);
  }
}
```

### Fetcher Resolution Priority

The fetcher used for making HTTP requests is determined by the following priority order:

1. **Service Instance Fetcher Property**: The `fetcher` property on the service instance has the highest priority
2. **Endpoint-Level Fetcher**: The fetcher specified in the endpoint metadata (`@get('/path', { fetcher: 'name' })`)
3. **Class-Level Fetcher**: The fetcher specified in the class metadata (`@api('/base', { fetcher: 'name' })`)
4. **Default Fetcher**: Falls back to the default fetcher if none of the above are specified

```typescript
// Example showing fetcher resolution priority
const customFetcher = new Fetcher({ baseURL: 'https://custom-api.com' });

@api('/users', { fetcher: 'class-level-fetcher' })
class UserService {
  @get('/{id}', { fetcher: 'endpoint-level-fetcher' })
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }
}

// Service instance with fetcher property (highest priority)
const userService = new UserService();
userService.fetcher = customFetcher; // This fetcher will be used

// If no fetcher property is set on the instance, it would use:
// 1. 'endpoint-level-fetcher' (from @get decorator)
// 2. 'class-level-fetcher' (from @api decorator)
// 3. Default fetcher (if neither of the above are specified)
```

### Result Extractors

Result extractors are used to process and extract data from different types of responses or results in the application.
They allow you to customize how the response from an HTTP request is processed and returned.

#### Available Result Extractors

- **ExchangeResultExtractor**: Returns the original FetchExchange object
- **ResponseResultExtractor**: Returns the response object from FetchExchange
- **JsonResultExtractor**: Parses the response content as JSON format (default)
- **TextResultExtractor**: Parses the response content as text format
- **EventStreamResultExtractor**: Extracts server-sent event stream from FetchExchange
- **JsonEventStreamResultExtractor**: Extracts JSON server-sent event stream from FetchExchange

#### Using Result Extractors

You can specify a result extractor at the class level or method level:

```typescript
import { ResultExtractors } from '@ahoo-wang/fetcher-decorator';

@api('/users', { resultExtractor: ResultExtractors.Json })
class UserService {
  // Uses class-level JSON result extractor
  @get('/{id}')
  getUser(@path() id: number): Promise<User> {
    throw autoGeneratedError(id);
  }

  // Overrides with EventStream result extractor
  @get('/events', { resultExtractor: ResultExtractors.EventStream })
  getUserEvents(): Promise<ServerSentEventStream> {
    throw autoGeneratedError();
  }

  // Uses JsonEventStream result extractor for JSON event handling
  @get('/json-events', {
    resultExtractor: ResultExtractors.JsonEventStream,
  })
  getJsonEvents(): Promise<JsonServerSentEventStream<MyDataType>> {
    throw autoGeneratedError();
  }
}
```

## üß™ Testing

```bash
# Run tests
pnpm test

# Run tests with coverage
pnpm test --coverage
```

## ü§ù Contributing

Contributions are welcome! Please see
the [contributing guide](https://github.com/Ahoo-Wang/fetcher/blob/main/CONTRIBUTING.md) for more details.

## üìÑ License

Apache-2.0

---

<p align="center">
  Part of the <a href="https://github.com/Ahoo-Wang/fetcher">Fetcher</a> ecosystem
</p>
