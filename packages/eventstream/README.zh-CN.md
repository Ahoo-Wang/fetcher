# @ahoo-wang/fetcher-eventstream

[![npm version](https://img.shields.io/npm/v/@ahoo-wang/fetcher-eventstream.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-eventstream)
[![Build Status](https://github.com/Ahoo-Wang/fetcher/actions/workflows/ci.yml/badge.svg)](https://github.com/Ahoo-Wang/fetcher/actions)
[![codecov](https://codecov.io/gh/Ahoo-Wang/fetcher/graph/badge.svg?token=JGiWZ52CvJ)](https://codecov.io/gh/Ahoo-Wang/fetcher)
[![License](https://img.shields.io/npm/l/@ahoo-wang/fetcher-eventstream.svg)](https://github.com/Ahoo-Wang/fetcher/blob/main/LICENSE)
[![npm downloads](https://img.shields.io/npm/dm/@ahoo-wang/fetcher-eventstream.svg)](https://www.npmjs.com/package/@ahoo-wang/fetcher-eventstream)
[![npm bundle size](https://img.shields.io/bundlephobia/minzip/%40ahoo-wang%2Ffetcher-eventstream)](https://www.npmjs.com/package/@ahoo-wang/fetcher-eventstream)
[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/Ahoo-Wang/fetcher)

ä¸º Fetcher æä¾› text/event-stream æ”¯æŒï¼Œå®ç°æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰åŠŸèƒ½ï¼Œç”¨äºå®æ—¶æ•°æ®æµã€‚

## ğŸŒŸ ç‰¹æ€§

- **ğŸ“¡ äº‹ä»¶æµè½¬æ¢**ï¼šå°† `text/event-stream` å“åº”è½¬æ¢ä¸º `ServerSentEvent` å¯¹è±¡çš„å¼‚æ­¥ç”Ÿæˆå™¨
- **ğŸ”Œ è‡ªåŠ¨æ‰©å±•**ï¼šæ¨¡å—å¯¼å…¥æ—¶è‡ªåŠ¨æ‰©å±• `Response` åŸå‹ï¼Œæ·»åŠ äº‹ä»¶æµæ–¹æ³•
- **ğŸ“‹ SSE è§£æ**ï¼šæ ¹æ®è§„èŒƒè§£ææœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ŒåŒ…æ‹¬æ•°æ®ã€äº‹ä»¶ã€ID å’Œé‡è¯•å­—æ®µ
- **ğŸ”„ æµæ”¯æŒ**ï¼šæ­£ç¡®å¤„ç†åˆ†å—æ•°æ®å’Œå¤šè¡Œäº‹ä»¶
- **ğŸ’¬ æ³¨é‡Šå¤„ç†**ï¼šæ­£ç¡®å¿½ç•¥æ³¨é‡Šè¡Œï¼ˆä»¥ `:` å¼€å¤´çš„è¡Œï¼‰
- **ğŸ›¡ï¸ TypeScript æ”¯æŒ**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šé«˜æ•ˆçš„è§£æå’Œæµå¤„ç†ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½åº”ç”¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# ä½¿ç”¨ npm
npm install @ahoo-wang/fetcher-eventstream

# ä½¿ç”¨ pnpm
pnpm add @ahoo-wang/fetcher-eventstream

# ä½¿ç”¨ yarn
yarn add @ahoo-wang/fetcher-eventstream
```

### æ¨¡å—å¯¼å…¥

è¦ä½¿ç”¨äº‹ä»¶æµåŠŸèƒ½ï¼Œæ‚¨éœ€è¦å¯¼å…¥æ¨¡å—ä»¥æ‰§è¡Œå…¶å‰¯ä½œç”¨ï¼š

```typescript
import '@ahoo-wang/fetcher-eventstream';
```

æ­¤å¯¼å…¥ä¼šè‡ªåŠ¨æ‰©å±• `Response` æ¥å£ä»¥å¤„ç†æœåŠ¡å™¨å‘é€äº‹ä»¶æµï¼š

- `eventStream()` - å°†å¸¦æœ‰ `text/event-stream` å†…å®¹ç±»å‹çš„å“åº”è½¬æ¢ä¸º `ServerSentEventStream`
- `jsonEventStream<DATA>()` - å°†å¸¦æœ‰ `text/event-stream` å†…å®¹ç±»å‹çš„å“åº”è½¬æ¢ä¸º `JsonServerSentEventStream<DATA>`
- `isEventStream` getter - æ£€æŸ¥å“åº”æ˜¯å¦å…·æœ‰ `text/event-stream` å†…å®¹ç±»å‹
- `requiredEventStream()` - è·å– `ServerSentEventStream`ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŠ›å‡ºé”™è¯¯
- `requiredJsonEventStream<DATA>()` - è·å– `JsonServerSentEventStream<DATA>`ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŠ›å‡ºé”™è¯¯

è¿™æ˜¯ JavaScript/TypeScript ä¸­å¸¸è§çš„æ¨¡å¼ï¼Œç”¨äºåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»å‹å®šä¹‰çš„æƒ…å†µä¸‹æ‰©å±•ç°æœ‰ç±»å‹çš„åŠŸèƒ½ã€‚

### é›†æˆæµ‹è¯•ç¤ºä¾‹ï¼šå¸¦äº‹ä»¶æµçš„ LLM å®¢æˆ·ç«¯

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºå¸¦äº‹ä»¶æµæ”¯æŒçš„ LLM å®¢æˆ·ç«¯ï¼Œç±»ä¼¼äº Fetcher
é¡¹ç›®ä¸­çš„é›†æˆæµ‹è¯•ã€‚æ‚¨å¯ä»¥åœ¨ [integration-test/src/eventstream/llmClient.ts](../../integration-test/src/eventstream/llmClient.ts)
ä¸­æ‰¾åˆ°å®Œæ•´å®ç°ã€‚

è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Fetcher çš„æµå¼ä¼ è¾“åŠŸèƒ½ä¸æµè¡Œçš„ LLM APIï¼ˆå¦‚ OpenAI çš„ GPT æ¨¡å‹ï¼‰è¿›è¡Œäº¤äº’ã€‚

```typescript
import {
  BaseURLCapable,
  ContentTypeValues,
  FetchExchange,
  NamedFetcher,
  REQUEST_BODY_INTERCEPTOR_ORDER,
  RequestInterceptor,
} from '@ahoo-wang/fetcher';
import {
  api,
  autoGeneratedError,
  body,
  post,
  ResultExtractors,
} from '@ahoo-wang/fetcher-decorator';
import '@ahoo-wang/fetcher-eventstream';
import { JsonServerSentEventStream } from '@ahoo-wang/fetcher-eventstream';
import { ChatRequest, ChatResponse } from './types';

export const llmFetcherName = 'llm';

export interface LlmOptions extends BaseURLCapable {
  apiKey: string;
  model?: string;
}

export class LlmRequestInterceptor implements RequestInterceptor {
  readonly name: string = 'LlmRequestInterceptor';
  readonly order: number = REQUEST_BODY_INTERCEPTOR_ORDER - 1;

  constructor(private llmOptions: LlmOptions) {}

  intercept(exchange: FetchExchange): void {
    const chatRequest = exchange.request.body as ChatRequest;
    if (!chatRequest.model) {
      chatRequest.model = this.llmOptions.model;
    }
  }
}

export function createLlmFetcher(options: LlmOptions): NamedFetcher {
  const llmFetcher = new NamedFetcher(llmFetcherName, {
    baseURL: options.baseURL,
    headers: {
      Authorization: `Bearer ${options.apiKey}`,
      'Content-Type': ContentTypeValues.APPLICATION_JSON,
    },
  });
  llmFetcher.interceptors.request.use(new LlmRequestInterceptor(options));
  return llmFetcher;
}

@api('/chat', {
  fetcher: llmFetcherName,
  resultExtractor: ResultExtractors.JsonEventStream,
})
export class LlmClient {
  @post('/completions')
  streamChat(
    @body() body: ChatRequest,
  ): Promise<JsonServerSentEventStream<ChatResponse>> {
    throw autoGeneratedError(body);
  }

  @post('/completions', { resultExtractor: ResultExtractors.Json })
  chat(@body() body: ChatRequest): Promise<ChatResponse> {
    throw autoGeneratedError(body);
  }
}
```

#### ä½¿ç”¨ streamChat è¿›è¡Œå®æ—¶å“åº”

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `streamChat` æ–¹æ³•ä» LLM API è·å–å®æ—¶å“åº”çš„ç¤ºä¾‹ï¼š

```typescript
import { createLlmFetcher, LlmClient } from './llmClient';

// ä½¿ç”¨æ‚¨çš„ API é…ç½®åˆå§‹åŒ– LLM å®¢æˆ·ç«¯
const llmFetcher = createLlmFetcher({
  baseURL: 'https://api.openai.com/v1', // OpenAI ç¤ºä¾‹
  apiKey: process.env.OPENAI_API_KEY || 'your-api-key',
  model: 'gpt-3.5-turbo', // é»˜è®¤æ¨¡å‹
});

// åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
const llmClient = new LlmClient();

// ç¤ºä¾‹ï¼šå®æ—¶æµå¼ä¼ è¾“èŠå¤©å®Œæˆå“åº”
async function streamChatExample() {
  try {
    // æµå¼ä¼ è¾“å“åº”ï¼Œé€ä¸ªä»¤ç‰Œæ¥æ”¶
    const stream = await llmClient.streamChat({
      messages: [
        { role: 'system', content: 'You are a helpful assistant.' },
        { role: 'user', content: 'Explain quantum computing in simple terms.' },
      ],
      model: 'gpt-3.5-turbo', // å¦‚éœ€è¦å¯è¦†ç›–é»˜è®¤æ¨¡å‹
      stream: true, // å¯ç”¨æµå¼ä¼ è¾“
    });

    // å¤„ç†æµå¼å“åº”
    let fullResponse = '';
    for await (const event of stream) {
      // æ¯ä¸ªäº‹ä»¶åŒ…å«éƒ¨åˆ†å“åº”
      if (event.data) {
        const chunk = event.data;
        const content = chunk.choices[0]?.delta?.content || '';
        fullResponse += content;
        console.log('æ–°ä»¤ç‰Œ:', content);

        // åœ¨ä»¤ç‰Œåˆ°è¾¾æ—¶å®æ—¶æ›´æ–° UI
        updateUI(content);
      }
    }

    console.log('å®Œæ•´å“åº”:', fullResponse);
  } catch (error) {
    console.error('æµå¼èŠå¤©é”™è¯¯:', error);
  }
}

// è¾…åŠ©å‡½æ•°æ¨¡æ‹Ÿ UI æ›´æ–°
function updateUI(content: string) {
  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™å°†æ›´æ–°æ‚¨çš„ UI
  process.stdout.write(content);
}
```

### åŸºæœ¬ç”¨æ³•

```typescript
import { Fetcher } from '@ahoo-wang/fetcher';
import '@ahoo-wang/fetcher-eventstream';

const fetcher = new Fetcher({
  baseURL: 'https://api.example.com',
});

// åœ¨å“åº”ä¸­ä½¿ç”¨ eventStream æ–¹æ³•å¤„ç† text/event-stream å†…å®¹ç±»å‹
// Response å¯¹è±¡å°†è‡ªåŠ¨å…·æœ‰ eventStream() å’Œ jsonEventStream() æ–¹æ³•
const response = await fetcher.get('/events');
for await (const event of response.requiredEventStream()) {
  console.log('æ”¶åˆ°äº‹ä»¶:', event);
}

// ä½¿ç”¨ jsonEventStream æ–¹æ³•å¤„ç† JSON æ•°æ®
const jsonResponse = await fetcher.get('/json-events');
for await (const event of response.requiredJsonEventStream<MyDataType>()) {
  console.log('æ”¶åˆ° JSON äº‹ä»¶:', event.data);
}
```

### æ‰‹åŠ¨è½¬æ¢

```typescript
import { toServerSentEventStream } from '@ahoo-wang/fetcher-eventstream';

// æ‰‹åŠ¨è½¬æ¢ Response å¯¹è±¡
const response = await fetch('/events');
const eventStream = toServerSentEventStream(response);

// ä»æµä¸­è¯»å–äº‹ä»¶
const reader = eventStream.getReader();
try {
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    console.log('æ”¶åˆ°äº‹ä»¶:', value);
  }
} finally {
  reader.releaseLock();
}
```

## ğŸ“š API å‚è€ƒ

### æ¨¡å—å¯¼å…¥

è¦ä½¿ç”¨äº‹ä»¶æµåŠŸèƒ½ï¼Œæ‚¨éœ€è¦å¯¼å…¥æ¨¡å—ä»¥æ‰§è¡Œå…¶å‰¯ä½œç”¨ï¼š

```typescript
import '@ahoo-wang/fetcher-eventstream';
```

æ­¤å¯¼å…¥ä¼šè‡ªåŠ¨æ‰©å±•å…¨å±€ `Response` æ¥å£ä»¥å¤„ç†æœåŠ¡å™¨å‘é€äº‹ä»¶æµï¼š

- `eventStream()` - å°†å¸¦æœ‰ `text/event-stream` å†…å®¹ç±»å‹çš„å“åº”è½¬æ¢ä¸º `ServerSentEventStream`
- `jsonEventStream<DATA>()` - å°†å¸¦æœ‰ `text/event-stream` å†…å®¹ç±»å‹çš„å“åº”è½¬æ¢ä¸º `JsonServerSentEventStream<DATA>`
- `isEventStream` getter - æ£€æŸ¥å“åº”æ˜¯å¦å…·æœ‰ `text/event-stream` å†…å®¹ç±»å‹
- `requiredEventStream()` - è·å– `ServerSentEventStream`ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŠ›å‡ºé”™è¯¯
- `requiredJsonEventStream<DATA>()` - è·å– `JsonServerSentEventStream<DATA>`ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŠ›å‡ºé”™è¯¯

è¿™æ˜¯ JavaScript/TypeScript ä¸­å¸¸è§çš„æ¨¡å¼ï¼Œç”¨äºåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»å‹å®šä¹‰çš„æƒ…å†µä¸‹æ‰©å±•ç°æœ‰ç±»å‹çš„åŠŸèƒ½ã€‚

åœ¨é›†æˆæµ‹è¯•å’Œå®é™…åº”ç”¨ä¸­ï¼Œæ­¤å¯¼å…¥å¯¹äºå¤„ç†äº‹ä»¶æµè‡³å…³é‡è¦ã€‚ä¾‹å¦‚ï¼š

```typescript
import { Fetcher } from '@ahoo-wang/fetcher';
import '@ahoo-wang/fetcher-eventstream';

const fetcher = new Fetcher({
  baseURL: 'https://api.example.com',
});

// Response å¯¹è±¡å°†è‡ªåŠ¨å…·æœ‰ eventStream() å’Œ jsonEventStream() æ–¹æ³•
const response = await fetcher.get('/events');
// å¤„ç†äº‹ä»¶æµ
for await (const event of response.requiredEventStream()) {
  console.log('æ”¶åˆ°äº‹ä»¶:', event);
}
```

### toJsonServerSentEventStream

å°† `ServerSentEventStream` è½¬æ¢ä¸º `JsonServerSentEventStream<DATA>`ï¼Œç”¨äºå¤„ç†å¸¦æœ‰ JSON æ•°æ®çš„æœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚

#### ç­¾å

```typescript
function toJsonServerSentEventStream<DATA>(
  serverSentEventStream: ServerSentEventStream,
): JsonServerSentEventStream<DATA>;
```

#### å‚æ•°

- `serverSentEventStream`ï¼šè¦è½¬æ¢çš„ ServerSentEventStream

#### è¿”å›

- `JsonServerSentEventStream<DATA>`ï¼šå¸¦æœ‰ JSON æ•°æ®çš„ ServerSentEvent å¯¹è±¡çš„å¯è¯»æµ

### JsonServerSentEvent

å®šä¹‰å¸¦æœ‰ JSON æ•°æ®çš„æœåŠ¡å™¨å‘é€äº‹ä»¶ç»“æ„çš„æ¥å£ã€‚

```typescript
interface JsonServerSentEvent<DATA> extends Omit<ServerSentEvent, 'data'> {
  data: DATA; // ä½œä¸ºè§£æ JSON çš„äº‹ä»¶æ•°æ®
}
```

### JsonServerSentEventStream

å¸¦æœ‰ JSON æ•°æ®çš„ ServerSentEvent å¯¹è±¡çš„å¯è¯»æµçš„ç±»å‹åˆ«åã€‚

```typescript
type JsonServerSentEventStream<DATA> = ReadableStream<
  JsonServerSentEvent<DATA>
>;
```

### toServerSentEventStream

å°†å¸¦æœ‰ `text/event-stream` ä¸»ä½“çš„ Response å¯¹è±¡è½¬æ¢ä¸º ServerSentEvent å¯¹è±¡çš„å¯è¯»æµã€‚

#### ç­¾å

```typescript
function toServerSentEventStream(response: Response): ServerSentEventStream;
```

#### å‚æ•°

- `response`ï¼šå¸¦æœ‰ `text/event-stream` å†…å®¹ç±»å‹çš„ HTTP å“åº”

#### è¿”å›

- `ServerSentEventStream`ï¼šServerSentEvent å¯¹è±¡çš„å¯è¯»æµ

### ServerSentEvent

å®šä¹‰æœåŠ¡å™¨å‘é€äº‹ä»¶ç»“æ„çš„æ¥å£ã€‚

```typescript
interface ServerSentEvent {
  data: string; // äº‹ä»¶æ•°æ®ï¼ˆå¿…éœ€ï¼‰
  event?: string; // äº‹ä»¶ç±»å‹ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º 'message'ï¼‰
  id?: string; // äº‹ä»¶ IDï¼ˆå¯é€‰ï¼‰
  retry?: number; // ä»¥æ¯«ç§’ä¸ºå•ä½çš„é‡è¯•è¶…æ—¶ï¼ˆå¯é€‰ï¼‰
}
```

### ServerSentEventStream

ServerSentEvent å¯¹è±¡çš„å¯è¯»æµçš„ç±»å‹åˆ«åã€‚

```typescript
type ServerSentEventStream = ReadableStream<ServerSentEvent>;
```

## ğŸ› ï¸ ç¤ºä¾‹

### å®æ—¶é€šçŸ¥

```typescript
import { Fetcher } from '@ahoo-wang/fetcher';
import '@ahoo-wang/fetcher-eventstream';

const fetcher = new Fetcher({
  baseURL: 'https://api.example.com',
});

// ç›‘å¬å®æ—¶é€šçŸ¥
const response = await fetcher.get('/notifications');
for await (const event of response.requiredEventStream()) {
  switch (event.event) {
    case 'message':
      showNotification('æ¶ˆæ¯', event.data);
      break;
    case 'alert':
      showAlert('è­¦æŠ¥', event.data);
      break;
    case 'update':
      handleUpdate(JSON.parse(event.data));
      break;
    default:
      console.log('æœªçŸ¥äº‹ä»¶:', event);
  }
}
```

### è¿›åº¦æ›´æ–°

```typescript
import { Fetcher } from '@ahoo-wang/fetcher';

const fetcher = new Fetcher({
  baseURL: 'https://api.example.com',
});

// è·Ÿè¸ªé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è¿›åº¦
const response = await fetcher.get('/tasks/123/progress');
for await (const event of response.requiredEventStream()) {
  if (event.event === 'progress') {
    const progress = JSON.parse(event.data);
    updateProgressBar(progress.percentage);
  } else if (event.event === 'complete') {
    showCompletionMessage(event.data);
    break;
  }
}
```

### èŠå¤©åº”ç”¨

```typescript
import { Fetcher } from '@ahoo-wang/fetcher';

const fetcher = new Fetcher({
  baseURL: 'https://chat-api.example.com',
});

// å®æ—¶èŠå¤©æ¶ˆæ¯
const response = await fetcher.get('/rooms/123/messages');
for await (const event of response.requiredEventStream()) {
  if (event.event === 'message') {
    const message = JSON.parse(event.data);
    displayMessage(message);
  } else if (event.event === 'user-joined') {
    showUserJoined(event.data);
  } else if (event.event === 'user-left') {
    showUserLeft(event.data);
  }
}
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œå¸¦è¦†ç›–ç‡çš„æµ‹è¯•
pnpm test -- --coverage
```

æµ‹è¯•å¥—ä»¶åŒ…æ‹¬ï¼š

- äº‹ä»¶æµè½¬æ¢æµ‹è¯•
- è¾¹ç¼˜æƒ…å†µå¤„ç†ï¼ˆæ ¼å¼é”™è¯¯çš„äº‹ä»¶ã€åˆ†å—æ•°æ®ç­‰ï¼‰
- å¤§äº‹ä»¶æµçš„æ€§èƒ½æµ‹è¯•

## ğŸ“‹ æœåŠ¡å™¨å‘é€äº‹ä»¶è§„èŒƒå…¼å®¹æ€§

æ­¤åŒ…å®Œå…¨å®ç°äº† [æœåŠ¡å™¨å‘é€äº‹ä»¶è§„èŒƒ](https://html.spec.whatwg.org/multipage/server-sent-events.html)ï¼š

- **æ•°æ®å­—æ®µ**ï¼šæ”¯æŒå¤šè¡Œæ•°æ®å­—æ®µ
- **äº‹ä»¶å­—æ®µ**ï¼šè‡ªå®šä¹‰äº‹ä»¶ç±»å‹
- **ID å­—æ®µ**ï¼šæœ€åäº‹ä»¶ ID è·Ÿè¸ª
- **é‡è¯•å­—æ®µ**ï¼šè‡ªåŠ¨é‡è¿è¶…æ—¶
- **æ³¨é‡Šè¡Œ**ï¼šå¿½ç•¥ä»¥ `:` å¼€å¤´çš„è¡Œ
- **äº‹ä»¶åˆ†å‘**ï¼šæ­£ç¡®çš„äº‹ä»¶åˆ†å‘ï¼Œé»˜è®¤äº‹ä»¶ç±»å‹ä¸º 'message'

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](https://github.com/Ahoo-Wang/fetcher/blob/main/CONTRIBUTING.md) äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache-2.0 è®¸å¯è¯](../../LICENSE)ã€‚

---

<p align="center">
  Fetcher ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†
</p>
